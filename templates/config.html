{% extends "base.html" %}
{% block content %}
<div class="container">
    <div class="header">
        <h1><i class="fas fa-cog"></i> 监控雷达设置 (V2.5.2)</h1>
        <p>在此全方位调整您的币圈雷达系统</p>
    </div>

    <!-- Section: Account Security -->
    <div class="card" style="border-left: 5px solid #6c5ce7;">
        <div class="card-header"><h3><i class="fas fa-user-shield"></i> 管理员账号安全</h3></div>
        <form action="/api/config/password" method="POST" style="display:grid; grid-template-columns: 1fr 1.5fr 1fr; gap:1rem; align-items:flex-end">
            <div class="form-group" style="margin:0">
                <label>当前旧密码</label>
                <input type="password" name="old_pass" required>
            </div>
            <div class="form-group" style="margin:0">
                <label>设置新密码</label>
                <input type="password" name="new_pass" required>
            </div>
            <button type="submit" class="btn btn-primary">更新安全密钥</button>
        </form>
    </div>

    <!-- Row 1: Engine & Telegram List -->
    <div style="display:grid; grid-template-columns: 1.2fr 2fr; gap: 2rem;">
        <div class="card">
            <div class="card-header"><h3><i class="fas fa-tachometer-alt"></i> 引擎调速</h3></div>
            <form action="/api/config/monitor" method="POST">
                <div class="form-group">
                    <label>全局扫描频率 (秒)</label>
                    <input type="number" name="interval" value="{{ monitor.check_interval }}">
                </div>
                <button type="submit" class="btn btn-primary">保存频率</button>
            </form>
        </div>
        
        <div class="card">
            <div class="card-header"><h3><i class="fab fa-telegram-plane"></i> 预警接收清单</h3></div>
            <table style="width:100%; margin-bottom:1rem">
                <thead><tr><th>接收站</th><th>ID</th><th>操作</th></tr></thead>
                <tbody>
                    {% for n in notifiers %}
                    <tr>
                        <td><small title="{{ n.token }}">{{ n.token[:12] }}...</small></td>
                        <td><code>{{ n.chat_id }}</code></td>
                        <td>
                            <form action="/api/config/telegram/delete/{{ loop.index0 }}" method="POST" onsubmit="return confirm('移除此接收端吗？')">
                                <button type="submit" class="btn btn-sm text-danger">移除</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <div style="border-top:1px dashed #f1f5f9; padding-top:1rem">
                <form action="/api/config/telegram/add" method="POST" style="display:flex; gap:0.5rem">
                    <input type="password" name="token" placeholder="Bot Token" required style="flex:1.5">
                    <input type="text" name="chat_id" placeholder="Chat ID" required style="flex:1">
                    <button type="submit" class="btn btn-sm btn-primary">增加</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Keyword Radar -->
    <div class="card">
        <div class="card-header"><h3><i class="fas fa-satellite-dish"></i> 智能关键词雷达</h3></div>
        <form action="/api/config/keywords" method="POST">
            <div class="form-group"><label>核心词 (触发必推)</label><input type="text" name="high" value="{{ keywords.high_priority | join(',') }}"></div>
            <div class="form-group"><label>观察词 (普通权重)</label><input type="text" name="medium" value="{{ keywords.medium_priority | join(',') }}"></div>
            <button type="submit" class="btn btn-primary" style="width:100%">同步并刷新雷达词库</button>
        </form>
    </div>

    <!-- Sources -->
    <div class="card">
        <div class="card-header"><h3><i class="fas fa-stream"></i> 活跃监控源列表</h3></div>
        <table style="width:100%; margin-bottom:1rem">
            <thead><tr><th>名称</th><th>类型</th><th>地址</th><th>操作</th></tr></thead>
            <tbody>
                {% for source in sources %}
                <tr>
                    <td>{{ source.name }}</td>
                    <td><span class="badge" style="background:#eef2ff; color:#6366f1; padding:2px 8px; border-radius:4px">{{ source.type }}</span></td>
                    <td><small>{{ source.url or source.repo }}</small></td>
                    <td>
                        <form action="/api/sources/delete/{{ loop.index0 }}" method="POST" onsubmit="return confirm('移除此监控源吗？')">
                            <button type="submit" class="btn btn-sm text-danger">移除</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <div style="border-top:1px dashed #f1f5f9; padding-top:1rem">
            <h4><i class="fas fa-plus-circle"></i> 添加新监控源</h4>
            <form action="/api/sources/add" method="POST" style="display:grid; grid-template-columns: 1fr 1fr 2fr auto; gap:0.5rem; margin-top:0.5rem">
                <input type="text" name="name" placeholder="显示名称" required>
                <select name="type" required style="padding:0.6rem; border-radius:8px; border:1px solid #e2e8f0; font-size:0.85rem; background:white">
                    <option value="rss">RSS 订阅</option>
                    <option value="github_releases">GitHub Release</option>
                </select>
                <input type="text" name="url" placeholder="URL 或 Repo (如: owner/repo)">
                <button type="submit" class="btn btn-sm btn-primary">添加源</button>
            </form>
            <p style="font-size:0.75rem; color:#64748b; margin-top:0.5rem">* 
                GitHub 类型填 <code>owner/repo</code>，RSS 类型填完整 <code>URL</code>
            </p>
        </div>
    </div>
</div>

<script>
    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('msg') === 'pass_updated') {
            alert("✅ 密码已成功更新并永久固化！以后请用新密码登录。");
        } else if (urlParams.get('error') === 'old_pass_wrong') {
            alert("❌ 旧密码输入错误，请重试。");
        }
    }
</script>

<style>
    .card { background: white; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    .card-header { border-bottom: 1px solid #f1f5f9; margin-bottom: 1rem; }
    .form-group label { display: block; font-weight: 600; margin-bottom: 0.3rem; font-size:0.8rem; }
    input { width: 100%; padding: 0.6rem; border: 1px solid #e2e8f0; border-radius: 8px; font-size:0.85rem; }
    table { width:100%; border-collapse: collapse; font-size:0.85rem; }
    th, td { text-align: left; padding: 0.6rem; border-bottom: 1px solid #f1f5f9; }
    .text-danger { color: #eb4d4b; border: none; background: none; cursor: pointer; }
    .text-danger:hover { text-decoration: underline; }
</style>
{% endblock %}
