{% extends "base.html" %}
{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <div>
        <h1 style="margin: 0;"><i class="fas fa-folder-open"></i> {{ subject.name }}</h1>
        <div style="display: flex; gap: 1rem; margin-top: 0.5rem; font-size: 0.9rem; color: #636e72;">
            <span>ğŸ“š æ€»é¢˜: {{ stats.total }}</span>
            <span style="color: var(--danger);">âŒ é”™é¢˜: {{ stats.wrong }}</span>
            <span style="color: #e67e22;">â­ éš¾ç‚¹: {{ stats.difficult }}</span>
        </div>
    </div>
    <div style="display: flex; gap: 1rem; align-items: center;">
        <div class="dropdown" style="position: relative;">
            <select id="studyMode"
                style="padding: 0.5rem; border-radius: 8px; border: 1px solid #dfe6e9; background: white; cursor: pointer;">
                <option value="all_loop">ğŸ”„ å…¨éƒ¨å¾ªç¯</option>
                <option value="error">âŒ é”™é¢˜å¤ä¹ </option>
                <option value="difficult">â­ éš¾ç‚¹æ”»å…‹</option>
                <option value="normal">ğŸ“š çº¯é¢˜åº“</option>
            </select>
        </div>
        <div class="dropdown" style="position: relative;">
            <select id="qType"
                style="padding: 0.5rem; border-radius: 8px; border: 1px solid #dfe6e9; background: white; cursor: pointer;">
                <option value="all">ğŸ“¦ å…¨éƒ¨é¢˜å‹</option>
                <option value="single">ğŸ”˜ å•é€‰é¢˜</option>
                <option value="multi">â˜‘ï¸ å¤šé€‰é¢˜</option>
                <option value="fill">ğŸ“ å¡«ç©ºé¢˜</option>
                <option value="essay">ğŸ“‘ å¤§é¢˜</option>
            </select>
        </div>
        <a href="/subject/{{ subject.id }}/add" class="btn btn-primary">
            <i class="fas fa-plus"></i> å½•é¢˜
        </a>
        <button onclick="startStudy()" class="btn" style="background: var(--success); color: white;">
            <i class="fas fa-play"></i> å¼€å§‹åˆ·é¢˜
        </button>
    </div>
</div>

<script>
    function startStudy() {
        const mode = document.getElementById('studyMode').value;
        const type = document.getElementById('qType').value;
        window.location.href = `/subject/{{ subject.id }}/study?mode=${mode}&qtype=${type}`;
    }
</script>

<div class="glass-card" style="padding: 0; overflow: hidden;">
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="border-bottom: 2px solid rgba(0,0,0,0.05); background: rgba(0,0,0,0.02);">
                <th style="padding: 1.2rem; text-align: left;">é¢˜ç›®å†…å®¹</th>
                <th style="padding: 1.2rem; text-align: center; width: 120px;">çŠ¶æ€</th>
                <th style="padding: 1.2rem; text-align: center; width: 120px;">ç±»å‹</th>
                <th style="padding: 1.2rem; text-align: center; width: 150px;">æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            {% for q in questions %}
            <tr style="border-bottom: 1px solid rgba(0,0,0,0.05); transition: 0.3s;"
                onmouseover="this.style.background='rgba(108, 92, 231, 0.03)'"
                onmouseout="this.style.background='transparent'">
                <td style="padding: 1.2rem;">
                    <div style="font-weight: 500; margin-bottom: 0.3rem;">
                        {{ q.question_text[:100] }}{% if q.question_text|length > 100 %}...{% endif %}
                        {% if not q.question_text %}ï¼ˆå›¾ç¤ºé¢˜ï¼‰{% endif %}
                    </div>
                    {% if q.source %}
                    <div style="font-size: 0.8rem; opacity: 0.5;">æ¥æº: {{ q.source }}</div>
                    {% endif %}
                </td>
                <td style="padding: 1.2rem; text-align: center;">
                    {% if q.wrong_count and q.wrong_count > 0 %}
                    <span class="badge" style="background: rgba(255, 118, 117, 0.1); color: #d63031;">é”™ {{ q.wrong_count
                        }} æ¬¡</span>
                    {% elif q.history_wrong == 1 %}
                    <span class="badge" style="background: rgba(255, 159, 67, 0.1); color: #e67e22;"
                        title="æ›¾åšé”™">æ›¾é”™</span>
                    {% endif %}

                    {% if q.is_difficult %}
                    <span class="badge" style="background: rgba(214, 48, 49, 0.1); color: var(--danger);">â­ å›°éš¾</span>
                    {% endif %}

                    {% if not q.wrong_count and not q.history_wrong and not q.is_difficult %}
                    <span class="badge" style="background: rgba(0, 184, 148, 0.1); color: var(--success);">æŒæ¡</span>
                    {% endif %}
                </td>
                <td style="padding: 1.2rem; text-align: center;">
                    <span style="font-size: 0.85rem; opacity: 0.7;">
                        {% if q.question_type == 'objective' %}å•é€‰
                        {% elif q.question_type == 'multi' %}å¤šé€‰
                        {% elif q.question_type == 'fill' %}å¡«ç©º
                        {% else %}å¤§é¢˜{% endif %}
                    </span>
                </td>
                <td style="padding: 1.2rem; text-align: center;">
                    <div style="display: flex; gap: 0.6rem; justify-content: center;">
                        <a href="/question/{{ q.id }}" class="btn btn-icon" title="é¢„è§ˆé¢˜ç›®">
                            <i class="fas fa-eye"></i>
                        </a>
                        {% if q.paper_id %}
                        <button onclick="cloneQuestion({{ q.id }})" class="btn btn-icon" style="color: var(--success);"
                            title="åŠ å…¥é¢˜åº“">
                            <i class="fas fa-plus-circle"></i>
                        </button>
                        {% else %}
                        <button onclick="deleteQuestion({{ q.id }})" class="btn btn-icon" style="color: var(--danger);"
                            title="åˆ é™¤"><i class="fas fa-trash-alt"></i></button>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="4" style="padding: 5rem; text-align: center; opacity: 0.5;">
                    <i class="fas fa-ghost" style="font-size: 4rem; display: block; margin-bottom: 1.5rem;"></i>
                    è¯¥ç§‘ç›®ä¸‹è¿˜æ²¡æœ‰é¢˜ç›®ï¼Œå¿«å»å½•å…¥ç¬¬ä¸€é“é¢˜å§ï¼
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<script>
    async function deleteQuestion(qid) {
        if (!confirm('ç¡®å®šä»é¢˜åº“ä¸­æ°¸ä¹…åˆ é™¤è¿™é“é¢˜å—ï¼Ÿ')) return;
        try {
            const res = await fetch(`/api/delete/${qid}`, { method: 'POST' });
            if (res.ok) {
                showToast("âœ… åˆ é™¤æˆåŠŸ", true);
                setTimeout(() => location.reload(), 500);
            } else {
                showToast("âŒ åˆ é™¤å¤±è´¥", false);
            }
        } catch (e) {
            console.error(e);
            showToast("âŒ ç½‘ç»œé”™è¯¯", false);
        }
    }

    async function cloneQuestion(qid) {
        try {
            const res = await fetch(`/api/clone-to-bank/${qid}`, { method: 'POST' });
            if (res.ok) {
                showToast("âœ… å·²åŠ å…¥é¢˜åº“", true);
                setTimeout(() => location.reload(), 500);
            } else {
                showToast("âŒ åŠ å…¥å¤±è´¥", false);
            }
        } catch (e) {
            console.error(e);
            showToast("âŒ ç½‘ç»œé”™è¯¯", false);
        }
    }
</script>
{% endblock %}