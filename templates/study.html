{% extends "base.html" %}
{% block content %}
<div class="study-container">
    <!-- Header: Progress & Info -->
    <div class="glass-card"
        style="padding: 1rem; display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <div>
            <h2 style="margin: 0; font-size: 1.2rem;">
                <i class="fas {% if is_paper %}fa-graduation-cap{% else %}fa-book-open{% endif %}"></i>
                {{ subject.name }}
            </h2>
            <div style="font-size: 0.8rem; opacity: 0.6; margin-top: 0.2rem;">
                æ¨¡å¼: {{ 'æ¨¡æ‹Ÿè€ƒè¯•' if is_paper else 'å¸¸è§„åˆ·é¢˜' }}
            </div>
        </div>
        <div style="text-align: right;">
            <div id="progress-text" style="font-weight: 600; color: var(--accent);">1 / {{ questions|length }}</div>
            <div
                style="width: 150px; height: 6px; background: rgba(0,0,0,0.05); border-radius: 3px; margin-top: 0.5rem; position: relative; overflow: hidden;">
                <div id="progress-bar" style="width: 0%; height: 100%; background: var(--accent); transition: 0.3s;">
                </div>
            </div>
        </div>
    </div>

    <!-- Question Display Area -->
    <div id="question-card" class="glass-card"
        style="padding: 2.5rem; min-height: 400px; display: flex; flex-direction: column; gap: 2rem;">
        <div id="question-text" style="font-size: 1.1rem; line-height: 1.8; color: var(--text);">
            <!-- Text injected via JS -->
        </div>

        <div id="question-images" style="display: flex; flex-direction: column; gap: 1rem;">
            <!-- Images injected via JS -->
        </div>

        <!-- User Input Area for Fill/Subjective -->
        <div id="user-input-area" style="display:none; margin-top:1.5rem">
            <label style="font-weight:600; font-size:0.9rem; color:var(--accent); display:block; margin-bottom:0.5rem">
                <i class="fas fa-pen"></i> è¯·åœ¨æ­¤ä½œç­”
            </label>
            <textarea id="user-answer-text" rows="4" placeholder="åœ¨æ­¤è¾“å…¥ä½ çš„ç­”æ¡ˆ..."
                style="width:100%; border:2px solid rgba(0,0,0,0.1); padding:1rem; border-radius:12px; font-size:1rem; resize:vertical"></textarea>
        </div>

        <div id="answer-area"
            style="display: none; border-top: 1px dashed rgba(0,0,0,0.1); padding-top: 2rem; margin-top: 1rem;">
            <div style="font-weight: 600; color: var(--success); margin-bottom: 1rem;">
                <i class="fas fa-check-circle"></i> å‚è€ƒè§£æ
            </div>
            <div id="answer-images" style="display: flex; flex-direction: column; gap: 1rem;">
                <!-- Answer images injected via JS -->
            </div>
        </div>
    </div>

    <!-- Controls -->
    <div style="margin-top: 2rem; display: flex; justify-content: space-between; align-items: center;">
        <button id="prev-btn" class="btn" onclick="prevQuestion()" disabled>
            <i class="fas fa-chevron-left"></i> ä¸Šä¸€é¢˜
        </button>

        <div style="display: flex; gap: 1rem;">
            <button id="toggle-answer-btn" class="btn btn-secondary" onclick="toggleAnswer()">
                <i class="fas fa-eye"></i> æŸ¥çœ‹ç­”æ¡ˆ
            </button>
            <div id="record-btns" style="display: none; gap: 1rem;">
                <button class="btn" style="background: rgba(0, 184, 148, 0.1); color: var(--success);"
                    onclick="record(1)">
                    <i class="fas fa-check"></i> æˆ‘åšå¯¹äº†
                </button>
                <button class="btn" style="background: rgba(255, 118, 117, 0.1); color: var(--danger);"
                    onclick="record(0)">
                    <i class="fas fa-times"></i> æˆ‘åšé”™äº†
                </button>
            </div>
        </div>

        <button id="next-btn" class="btn btn-primary" onclick="nextQuestion()">
            ä¸‹ä¸€é¢˜ <i class="fas fa-chevron-right"></i>
        </button>
    </div>
</div>

<script>
    const questions = {{ questions| tojson }};
    let currentIndex = 0;
    let selectedOpts = new Set(); // V1.3.14: Track interactions

    function renderQuestion() {
        if (questions.length === 0) {
            document.getElementById('question-card').innerHTML = `
                <div style="text-align: center; padding: 5rem; opacity: 0.5;">
                    <i class="fas fa-ghost" style="font-size: 4rem; display: block; margin-bottom: 1rem;"></i>
                    é¢˜åº“æ˜¯ç©ºçš„ï¼Œå¿«å»æ·»åŠ ä¸€äº›é¢˜ç›®å§ï¼
                </div>
            `;
            return;
        }

        const q = questions[currentIndex];
        const qTextEl = document.getElementById('question-text');
        const qImgsEl = document.getElementById('question-images');
        const aImgsEl = document.getElementById('answer-images');
        const answerArea = document.getElementById('answer-area');

        // Reset UI & State
        selectedOpts.clear();
        answerArea.style.display = 'none';
        document.getElementById('toggle-answer-btn').style.display = 'inline-flex';
        document.getElementById('record-btns').style.display = 'none';

        // V1.3.14: Multi-select support
        const isMulti = q.question_type === 'multi';

        // Render Question Text
        let typeBadge = '';
        if (isMulti) typeBadge = '<span class="badge" style="background:var(--accent); color:white; margin-right:0.5rem; font-size:0.8rem">å¤šé€‰</span>';
        qTextEl.innerHTML = typeBadge + (q.question_text || 'å›¾ç¤ºé¢˜');

        // Render Options
        let optsHtml = '';
        ['a', 'b', 'c', 'd'].forEach(key => {
            const val = q[`option_${key}`];
            if ((val && val.trim()) || ['objective', 'multi'].includes(q.question_type)) {
                optsHtml += `
                    <div class="opt" id="opt-${key}" onclick="handleOptClick('${key}', '${q.question_type}')">
                        <span class="badge" style="background:rgba(108,92,231,0.1); color:var(--accent)">${key.toUpperCase()}</span>
                        <span>${val || ''}</span>
                    </div>
                `;
            }
        });

        // Add Submit Button for Multi
        if (isMulti) {
            optsHtml += `
                <button id="btn-submit-multi" class="btn btn-primary" style="width:100%; margin-top:1rem" onclick="submitMulti()">
                    ç¡®è®¤ç­”æ¡ˆ <i class="fas fa-check"></i>
                </button>
            `;
        }

        const optBox = document.createElement('div');
        optBox.className = 'opt-box';
        optBox.id = 'opt-box';
        optBox.innerHTML = optsHtml;

        // Render Question Images
        qImgsEl.innerHTML = q.q_imgs.map(path => `<img src="${path}" class="q-image">`).join('');
        if (optsHtml) {
            qImgsEl.appendChild(optBox);
            document.getElementById('user-input-area').style.display = 'none';
        } else {
            const inputArea = document.getElementById('user-input-area');
            inputArea.style.display = 'block';
            document.getElementById('user-answer-text').value = '';
        }

        // Render Answer Area (kept same)
        let aHtml = '';
        if (q.correct_answer && q.correct_answer.trim()) {
            aHtml += `<div style="margin-bottom: 1.5rem; font-size: 1.1rem;">æ ‡å‡†ç­”æ¡ˆ: <span style="color:var(--success); font-weight:700">${q.correct_answer}</span></div>`;
        }
        if (q.q_text && q.q_text.includes('ã€è§£æã€‘')) { }
        aHtml += q.a_imgs.map(path => `<img src="${path}" class="q-image">`).join('');
        if (!aHtml && !q.correct_answer) {
            aHtml = '<div style="opacity:0.5; text-align:center; padding:1rem">è¯¥é¢˜ç›®æœªå½•å…¥æ–‡å­—ç­”æ¡ˆæˆ–è§£æå›¾</div>';
        }
        aImgsEl.innerHTML = aHtml;

        // Progress
        document.getElementById('progress-text').textContent = `${currentIndex + 1} / ${questions.length}`;
        document.getElementById('progress-bar').style.width = `${((currentIndex + 1) / questions.length) * 100}%`;

        // Buttons
        document.getElementById('prev-btn').disabled = currentIndex === 0;
        document.getElementById('next-btn').innerHTML = currentIndex === questions.length - 1 ? 'å®Œæˆå­¦ä¹  <i class="fas fa-flag-checkered"></i>' : 'ä¸‹ä¸€é¢˜ <i class="fas fa-chevron-right"></i>';
    }

    // V1.3.14: Unified Handler
    function handleOptClick(key, type) {
        // If already showing answer, disable clicks
        if (document.getElementById('answer-area').style.display === 'block') return;

        if (type === 'multi') {
            // Toggle
            const el = document.getElementById(`opt-${key}`);
            if (selectedOpts.has(key)) {
                selectedOpts.delete(key);
                el.style.borderColor = 'transparent';
                el.style.background = 'white';
            } else {
                selectedOpts.add(key);
                el.style.borderColor = 'var(--accent)';
                el.style.background = 'rgba(108,92,231,0.05)';
            }
        } else {
            // Single choice: Immediate check
            checkAnswer(key);
        }
    }

    // V1.3.14: Multi-Submit
    function submitMulti() {
        const answer = Array.from(selectedOpts).sort().join('').toUpperCase();
        if (!answer) {
            showToast("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªé€‰é¡¹", false);
            return;
        }
        checkAnswer(answer);
    }

    function checkAnswer(userAnswer) {
        const q = questions[currentIndex];
        // Normalize strings
        const correct = (q.correct_answer || '').trim().toUpperCase();
        const user = userAnswer.trim().toUpperCase();

        const isCorrect = user === correct;

        // Visual Feedback
        document.querySelectorAll('.opt').forEach(o => {
            o.classList.remove('correct', 'wrong');
            o.style.borderColor = 'transparent'; // Reset multi styles
            o.style.background = 'white';
        });

        // Highlight selected/clicked
        // For multi, highlight all selected. For single, highlight the one clicked.
        if (q.question_type === 'multi') {
            user.split('').forEach(k => {
                const el = document.getElementById(`opt-${k.toLowerCase()}`);
                if (el) el.classList.add(isCorrect ? 'correct' : 'wrong');
            });
        } else {
            // For single, user is just one char
            const el = document.getElementById(`opt-${user.toLowerCase()}`);
            if (el) el.classList.add(isCorrect ? 'correct' : 'wrong');
        }

        if (isCorrect) {
            showToast("å›ç­”æ­£ç¡®ï¼", true);
            // V1.3.14: Auto-record Correct
            record(1);
            setTimeout(toggleAnswer, 500);
        } else {
            showToast("ç­”æ¡ˆé”™è¯¯", false);
            // V1.3.14: Auto-record Wrong
            record(0);
        }
    }

    function toggleAnswer() {
        document.getElementById('answer-area').style.display = 'block';
        document.getElementById('toggle-answer-btn').style.display = 'none';
        document.getElementById('record-btns').style.display = 'inline-flex';
        // Hide submit btn if multi
        const subBtn = document.getElementById('btn-submit-multi');
        if (subBtn) subBtn.style.display = 'none';

        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }

    async function record(ok) {
        const q = questions[currentIndex];
        try {
            const resp = await fetch('/api/record', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ qid: q.id, ok: !!ok })
            });
            if (resp.ok) {
                console.log("Record saved:", ok);
                // V1.3.20: Add Feedback for Manual Record (Subjective)
                // If called manually (not checkAnswer), we can infer by context or just always toast?
                // checkAnswer already toasted. Let's just Toast again or check if existing toast?
                // Actually, checkAnswer calls record(1/0). Manual buttons call record(true/false).
                // Let's distinguish by type of 'ok'.
                // But checkAnswer passes 1/0 which is truthy/falsy.
                // Simplest: Just show "å·²æ ‡è®°ä¸ºæŒæ¡/é”™è¯¯"
                if (ok) showToast("ğŸ‰ å·²æ ‡è®°ä¸ºæ­£ç¡®/æŒæ¡", true);
                else showToast("å·²æ ‡è®°ä¸ºé”™è¯¯/éš¾ç‚¹", false);
            }
        } catch (e) {
            showToast("âŒ è®°å½•å¤±è´¥", false);
        }
        console.error(e);
        alert('ä¿å­˜è¿›åº¦å¤±è´¥');
    }
    }

    function nextQuestion() {
        if (currentIndex < questions.length - 1) {
            currentIndex++;
            renderQuestion();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        } else {
            location.href = '/';
        }
    }

    function prevQuestion() {
        if (currentIndex > 0) {
            currentIndex--;
            renderQuestion();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }

    // Initial render
    renderQuestion();
</script>

<style>
    .study-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 2rem 0;
    }
</style>
{% endblock %}