{% extends "base.html" %}
{% block content %}
<div class="study-container">
    <!-- Header: Progress & Info -->
    <div class="glass-card"
        style="padding: 1rem; display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <div>
            <h2 style="margin: 0; font-size: 1.2rem;">
                <i class="fas {% if is_paper %}fa-graduation-cap{% else %}fa-book-open{% endif %}"></i>
                {{ subject.name }}
            </h2>
            <div style="font-size: 0.8rem; opacity: 0.6; margin-top: 0.2rem;">
                模式: {{ '模拟考试' if is_paper else '常规刷题' }}
            </div>
        </div>
        <div style="text-align: right;">
            <div id="progress-text" style="font-weight: 600; color: var(--accent);">1 / {{ questions|length }}</div>
            <div
                style="width: 150px; height: 6px; background: rgba(0,0,0,0.05); border-radius: 3px; margin-top: 0.5rem; position: relative; overflow: hidden;">
                <div id="progress-bar" style="width: 0%; height: 100%; background: var(--accent); transition: 0.3s;">
                </div>
            </div>
        </div>
    </div>

    <!-- Question Display Area -->
    <div id="question-card" class="glass-card"
        style="padding: 2.5rem; min-height: 400px; display: flex; flex-direction: column; gap: 2rem;">
        <div id="question-text" style="font-size: 1.1rem; line-height: 1.8; color: var(--text);">
            <!-- Text injected via JS -->
        </div>

        <div id="question-images" style="display: flex; flex-direction: column; gap: 1rem;">
            <!-- Images injected via JS -->
        </div>

        <!-- User Input Area for Fill/Subjective -->
        <div id="user-input-area" style="display:none; margin-top:1.5rem">
            <label style="font-weight:600; font-size:0.9rem; color:var(--accent); display:block; margin-bottom:0.5rem">
                <i class="fas fa-pen"></i> 请在此作答
            </label>
            <textarea id="user-answer-text" rows="4" placeholder="在此输入你的答案..."
                style="width:100%; border:2px solid rgba(0,0,0,0.1); padding:1rem; border-radius:12px; font-size:1rem; resize:vertical"></textarea>
        </div>

        <div id="answer-area"
            style="display: none; border-top: 1px dashed rgba(0,0,0,0.1); padding-top: 2rem; margin-top: 1rem;">
            <div style="font-weight: 600; color: var(--success); margin-bottom: 1rem;">
                <i class="fas fa-check-circle"></i> 参考解析
            </div>
            <div id="answer-images" style="display: flex; flex-direction: column; gap: 1rem;">
                <!-- Answer images injected via JS -->
            </div>
        </div>
    </div>

    <!-- Controls -->
    <div style="margin-top: 2rem; display: flex; justify-content: space-between; align-items: center;">
        <button id="prev-btn" class="btn" onclick="prevQuestion()" disabled>
            <i class="fas fa-chevron-left"></i> 上一题
        </button>

        <div style="display: flex; gap: 1rem;">
            <button id="toggle-answer-btn" class="btn btn-secondary" onclick="toggleAnswer()">
                <i class="fas fa-eye"></i> 查看答案
            </button>
            <div id="record-btns" style="display: none; gap: 1rem;">
                <button class="btn" style="background: rgba(0, 184, 148, 0.1); color: var(--success);"
                    onclick="record(1)">
                    <i class="fas fa-check"></i> 我做对了
                </button>
                <button class="btn" style="background: rgba(255, 118, 117, 0.1); color: var(--danger);"
                    onclick="record(0)">
                    <i class="fas fa-times"></i> 我做错了
                </button>
            </div>
        </div>

        <button id="next-btn" class="btn btn-primary" onclick="nextQuestion()">
            下一题 <i class="fas fa-chevron-right"></i>
        </button>
    </div>
</div>

<script>
    const questions = {{ questions| tojson }};
    let currentIndex = 0;

    function renderQuestion() {
        if (questions.length === 0) {
            document.getElementById('question-card').innerHTML = `
                <div style="text-align: center; padding: 5rem; opacity: 0.5;">
                    <i class="fas fa-ghost" style="font-size: 4rem; display: block; margin-bottom: 1rem;"></i>
                    题库是空的，快去添加一些题目吧！
                </div>
            `;
            return;
        }

        const q = questions[currentIndex];
        const qTextEl = document.getElementById('question-text');
        const qImgsEl = document.getElementById('question-images');
        const aImgsEl = document.getElementById('answer-images');
        const answerArea = document.getElementById('answer-area');

        // Reset
        answerArea.style.display = 'none';
        document.getElementById('toggle-answer-btn').style.display = 'inline-flex';
        document.getElementById('record-btns').style.display = 'none';

        // Render Question Text
        qTextEl.textContent = q.question_text || '图示题';

        // Render Options if any (A, B, C, D)
        let optsHtml = '';
        ['a', 'b', 'c', 'd'].forEach(key => {
            const val = q[`option_${key}`];
            // Render if value exists OR if it's an objective/multi question (forcing buttons for image-based options)
            if ((val && val.trim()) || ['objective', 'multi'].includes(q.question_type)) {
                optsHtml += `
                    <div class="opt" id="opt-${key}" onclick="checkOpt('${key}')">
                        <span class="badge" style="background:rgba(108,92,231,0.1); color:var(--accent)">${key.toUpperCase()}</span>
                        <span>${val || ''}</span>
                    </div>
                `;
            }
        });

        const optBox = document.createElement('div');
        optBox.className = 'opt-box';
        optBox.id = 'opt-box';
        optBox.innerHTML = optsHtml;

        // Render Question Images
        qImgsEl.innerHTML = q.q_imgs.map(path => `<img src="${path}" class="q-image">`).join('');
        if (optsHtml) {
            qImgsEl.appendChild(optBox);
            document.getElementById('user-input-area').style.display = 'none';
        } else {
            // Show text input for fill/subjective
            const inputArea = document.getElementById('user-input-area');
            inputArea.style.display = 'block';
            document.getElementById('user-answer-text').value = ''; // Reset
        }

        // Render Answer Area
        let aHtml = '';
        if (q.correct_answer && q.correct_answer.trim()) {
            aHtml += `<div style="margin-bottom: 1.5rem; font-size: 1.1rem;">标准答案: <span style="color:var(--success); font-weight:700">${q.correct_answer}</span></div>`;
        }
        if (q.q_text && q.q_text.includes('【解析】')) {
            // If parsed text available
        }
        aHtml += q.a_imgs.map(path => `<img src="${path}" class="q-image">`).join('');
        if (!aHtml && !q.correct_answer) {
            aHtml = '<div style="opacity:0.5; text-align:center; padding:1rem">该题目未录入文字答案或解析图</div>';
        }
        aImgsEl.innerHTML = aHtml;

        // Progress
        document.getElementById('progress-text').textContent = `${currentIndex + 1} / ${questions.length}`;
        document.getElementById('progress-bar').style.width = `${((currentIndex + 1) / questions.length) * 100}%`;

        // Buttons
        document.getElementById('prev-btn').disabled = currentIndex === 0;
        document.getElementById('next-btn').innerHTML = currentIndex === questions.length - 1 ? '完成学习 <i class="fas fa-flag-checkered"></i>' : '下一题 <i class="fas fa-chevron-right"></i>';
    }

    function checkOpt(key) {
        const q = questions[currentIndex];
        const isCorrect = key.toUpperCase() === q.correct_answer.toUpperCase();
        const el = document.getElementById(`opt-${key}`);

        // Highlight logic
        document.querySelectorAll('.opt').forEach(o => o.classList.remove('correct', 'wrong'));
        el.classList.add(isCorrect ? 'correct' : 'wrong');

        if (isCorrect) {
            showToast("回答正确！", true);
            setTimeout(toggleAnswer, 500);
        } else {
            showToast("再想想看？", false);
        }
    }

    function toggleAnswer() {
        document.getElementById('answer-area').style.display = 'block';
        document.getElementById('toggle-answer-btn').style.display = 'none';
        document.getElementById('record-btns').style.display = 'inline-flex';
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }

    async function record(ok) {
        const q = questions[currentIndex];
        try {
            const resp = await fetch('/api/record', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ qid: q.id, ok: !!ok })
            });
            if (resp.ok) {
                // V1.3.7: Visual feedback
                if (ok) showToast("✅ 已标记为：掌握", true);
                else showToast("❌ 已标记为：错题", false);

                if (currentIndex < questions.length - 1) {
                    setTimeout(nextQuestion, 500); // Slight delay to see toast
                } else {
                    alert('学习完成！恭喜你完成了本组题目的练习。');
                    location.href = '/';
                }
            }
        } catch (e) {
            console.error(e);
            alert('保存进度失败');
        }
    }

    function nextQuestion() {
        if (currentIndex < questions.length - 1) {
            currentIndex++;
            renderQuestion();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        } else {
            location.href = '/';
        }
    }

    function prevQuestion() {
        if (currentIndex > 0) {
            currentIndex--;
            renderQuestion();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }

    // Initial render
    renderQuestion();
</script>

<style>
    .study-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 2rem 0;
    }
</style>
{% endblock %}