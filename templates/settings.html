{% extends "base.html" %}
{% block content %}
<div class="glass-card" style="max-width:700px; margin:auto">
    <h2 style="margin-bottom:2rem"><i class="fas fa-sliders-h"></i> ç³»ç»Ÿæ§åˆ¶ä¸­å¿ƒ</h2>

    <!-- Section 0: System Diagnosis (V1.3.12) -->
    <section id="diagnosis-card" style="display:none; margin-bottom:2.5rem">
        <div class="glass-card"
            style="background:rgba(231, 76, 60, 0.1); border:1px solid var(--danger); padding:1.2rem">
            <h3 style="color:var(--danger); margin-top:0"><i class="fas fa-heartbeat"></i> ç³»ç»Ÿè¯Šæ–­è­¦æŠ¥</h3>
            <p style="color:var(--danger)"><strong>æ£€æµ‹åˆ°ä¸¥é‡æ•°æ®åº“é—®é¢˜ï¼š</strong> ç¼ºå°‘ `history_wrong` å­—æ®µã€‚</p>
            <p style="font-size:0.9rem; color:#636e72">è¿™ä¼šå¯¼è‡´â€œé”™é¢˜/éš¾ç‚¹â€çŠ¶æ€æ— æ³•ä¿å­˜ï¼Œç»Ÿè®¡æ•°æ®ä¸º0ã€‚ç”±äºNASæƒé™æˆ–ç¯å¢ƒé—®é¢˜ï¼Œè‡ªåŠ¨ä¿®å¤å¯èƒ½å¤±è´¥ã€‚</p>
            <div style="margin-top:1rem">
                <button id="btn-fix-db" class="btn btn-danger">
                    <i class="fas fa-tools"></i> ç«‹å³å¼ºåˆ¶ä¿®å¤æ•°æ®åº“
                </button>
            </div>
            <div id="fix-logs"
                style="margin-top:1rem; font-family:monospace; font-size:0.85rem; background:rgba(0,0,0,0.05); padding:0.8rem; border-radius:6px; display:none">
            </div>
        </div>
    </section>

    <!-- Section 1: User Profile -->
    <section style="margin-bottom:2.5rem">
        <h3 style="font-size:1.1rem; opacity:0.8">ä¸ªäººä¸­å¿ƒ</h3>
        <div class="glass-card" style="background:rgba(255,255,255,0.3); padding:1.2rem">
            <p style="margin:0 0 1rem 0; font-weight:600">ä¿®æ”¹ç™»å½•å¯†ç </p>
            <form action="/api/change-password" method="POST" style="display:flex; flex-direction:column; gap:1rem">
                <div style="display:flex; gap:1rem">
                    <input type="password" name="old_pwd" placeholder="å½“å‰å¯†ç " required style="flex:1">
                    <input type="password" name="new_pwd" placeholder="æ–°å¯†ç " required style="flex:1">
                </div>
                <button type="submit" class="btn btn-primary" style="align-self: flex-end;">ç¡®è®¤ä¿®æ”¹</button>
            </form>
        </div>
    </section>

    <!-- Section 2: Basic Config -->
    <section style="margin-bottom:2.5rem">
        <h3 style="font-size:1.1rem; opacity:0.8">åŸºç¡€é…ç½®</h3>
        <form action="/settings/update" method="POST" class="glass-card"
            style="background:rgba(255,255,255,0.3); padding:1.2rem">
            <label style="font-size:0.85rem; font-weight:600; margin-bottom:0.5rem; display:block">è½¯ä»¶æ˜¾ç¤ºåç§°</label>
            <div style="display:flex; gap:1rem">
                <input type="text" name="app_name" value="{{ app_name }}" required style="flex:1">
                <button type="submit" class="btn btn-primary">ä¿å­˜</button>
            </div>
        </form>
    </section>

    <!-- Section 3: Data Management -->
    <section style="margin-bottom:2.5rem">
        <h3 style="font-size:1.1rem; opacity:0.8">æ•°æ®ç®¡ç† (å±é™©åŒº)</h3>
        <div class="glass-card" style="background:rgba(108, 92, 231, 0.05); padding:1.2rem">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem">
                <div>
                    <p style="margin:0; font-weight:600">å…¨åº“å¤‡ä»½å¯¼å‡º</p>
                    <small style="color:#636e72">ä¸‹è½½ ZIP åŒ…ï¼ŒåŒ…å«æ‰€æœ‰é¢˜ç›®æ•°æ®åŠå›¾ç‰‡</small>
                </div>
                <a href="/api/backup" class="btn btn-primary"><i class="fas fa-file-export"></i> ç«‹å³å¯¼å‡º</a>
            </div>

            <div style="padding-top:1.5rem; border-top:1px solid rgba(0,0,0,0.1)">
                <p style="margin:0 0 1rem 0; font-weight:600">æ¢å¤å¤‡ä»½ / åˆå¹¶æ•°æ®</p>
                <form action="/api/restore" method="POST" enctype="multipart/form-data"
                    onsubmit="return confirm('æ³¨æ„ï¼šå°†æ‰§è¡Œæ™ºèƒ½åˆå¹¶ï¼Œè·³è¿‡é‡å¤é¡¹ï¼Œå¢åŠ æ–°é¡¹ã€‚ç¡®å®šç»§ç»­å—ï¼Ÿ')">
                    <div style="display:flex; gap:0.5rem">
                        <input type="file" name="file" accept=".zip" required style="font-size:0.8rem">
                        <button type="submit" class="btn"
                            style="background:var(--accent); color:white; white-space:nowrap">ä¸Šä¼ åŒæ­¥</button>
                    </div>
                </form>
            </div>

            <div
                style="padding-top:1.5rem; border-top:1px solid rgba(0,0,0,0.1); margin-top:1.5rem; display:flex; justify-content:space-between; align-items:center">
                <div>
                    <p style="margin:0; font-weight:600">æˆ˜ç»©å½’é›¶</p>
                    <small style="color:#636e72">ä»…æ¸…é™¤åšé¢˜å†å²è®°å½•ï¼Œä¿ç•™é¢˜åº“</small>
                </div>
                <button onclick="resetStats()" class="btn"
                    style="background:rgba(214, 48, 49, 0.1); color:var(--danger)"><i class="fas fa-broom"></i>
                    æ¸…ç©ºç»Ÿè®¡</button>
            </div>

            <div
                style="padding-top:1.5rem; border-top:1px solid var(--danger); margin-top:1.5rem; display:flex; justify-content:space-between; align-items:center">
                <div>
                    <p style="margin:0; font-weight:600; color:var(--danger)">æ ¸å¼¹çº§é‡ç½®</p>
                    <small style="color:var(--danger)">å½»åº•æ¸…ç©ºæ‰€æœ‰é¢˜ç›®ã€ç§‘ç›®ã€è®°å½•å’Œå›¾ç‰‡</small>
                </div>
                <button onclick="nuclearReset()" class="btn" style="background:var(--danger); color:white"><i
                        class="fas fa-radiation"></i> å½»åº•æ¸…ç©º</button>
            </div>
        </div>
    </section>

    <!-- Section 4: Subject Management -->
    <section style="margin-bottom:2.5rem">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem">
            <h3 style="font-size:1.1rem; opacity:0.8; margin:0">ç§‘ç›®åˆ†ç±»ç®¡ç†</h3>
            <button class="btn btn-primary" style="padding:0.4rem 0.8rem; font-size:0.85rem" onclick="addSubject()">+
                æ–°å¢ç§‘ç›®</button>
        </div>
        <div class="glass-card" style="padding:0">
            <table style="width:100%">
                {% for s in subjects %}
                <tr style="border-bottom:1px solid rgba(0,0,0,0.05)">
                    <td style="padding:1rem; font-weight:600">{{ s.name }}</td>
                    <td style="text-align:right; padding:1rem">
                        <form action="/subject/delete/{{ s.id }}" method="POST" onsubmit="return confirm('ç¡®å®šåˆ é™¤è¯¥ç§‘ç›®å—ï¼Ÿ')"
                            style="display:inline">
                            <button type="submit" class="btn btn-icon" style="color:var(--danger)"><i
                                    class="fas fa-trash-alt"></i></button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </table>
        </div>
    </section>

    <!-- Section 5: About -->
    <section>
        <h3 style="font-size:1.1rem; opacity:0.8">å…³äºè½¯ä»¶</h3>
        <div class="glass-card" style="text-align:center; padding:2rem">
            <div
                style="font-size:1.4rem; font-weight:700; background:var(--primary); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin-bottom:0.5rem">
                {{ app_name }}
            </div>
            <div style="font-size:0.9rem; color:var(--accent); font-weight:600; margin-bottom:1.5rem">Study Helper Pro
                V1.3.7</div>
            <p style="font-size:0.9rem; color:#636e72; line-height:1.7; text-align:left; margin-bottom:2rem">
                ä¸“ä¸ºå®¶åº­æ•™è‚²è®¾è®¡çš„æ™ºèƒ½åŠ©å­¦ç³»ç»Ÿã€‚æ”¯æŒè¯•å·åˆ‡é¢˜ã€å¤šç«¯åŒæ­¥ã€é”™é¢˜å¼ºåŒ–ç»ƒä¹ ï¼Œå¸®åŠ©å­©å­é«˜æ•ˆæ”»å…‹çŸ¥è¯†è–„å¼±ç‚¹ã€‚
            </p>
            <div style="display:flex; justify-content:center; gap:3rem; align-items:center">
                <div style="text-align:center">
                    <div
                        style="width:100px; height:100px; background:#f0f2f5; border-radius:12px; display:flex; align-items:center; justify-content:center; border:1px solid rgba(0,0,0,0.1); margin-bottom:0.5rem">
                        <i class="fab fa-weixin" style="font-size:3rem; color:#07c160"></i>
                    </div>
                    <small style="color:#636e72">è”ç³»ä½œè€…</small>
                </div>
                <div style="text-align:left">
                    <p style="margin:0 0 0.5rem 0; font-size:0.9rem"><b>æŠ€æœ¯æ”¯æŒï¼š</b> antigravity</p>
                    <p style="margin:0; font-size:0.9rem"><b>ä½œè€…ï¼š</b> <a href="https://github.com/doge2mars"
                            target="_blank" style="color:var(--accent); text-decoration:none">doge2mars</a></p>
                </div>
            </div>
        </div>
    </section>
</div>

<script>
    async function nuclearReset() {
        const input = prompt('Ã°Å¸Å¡Â¨ è­¦å‘Šï¼šæ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤å…¨åº“æ‰€æœ‰é¢˜ç›®ã€å›¾ç‰‡å’Œç§‘ç›®ï¼\n\nå¦‚æœç¡®å®šè¦æ‰§è¡Œã€æ ¸å¼¹çº§æ¸…ç©ºã€‘ï¼Œè¯·åœ¨ä¸‹æ–¹è¾“å…¥â€œç¡®è®¤â€äºŒå­—ï¼š');
        if (input === 'ç¡®è®¤') {
            await fetch('/api/nuclear-reset', { method: 'POST' });
            location.href = '/settings?msg=nuclear_ok';
        } else if (input !== null) {
            alert('éªŒè¯å¤±è´¥ï¼Œæ“ä½œå·²å–æ¶ˆã€‚');
        }
    }

    async function resetStats() {
        if (confirm('ä»…æ¸…ç©ºåšé¢˜è®°å½•ç»Ÿè®¡ï¼Œä¿ç•™åº“å†…é¢˜ç›®ã€‚ç¡®å®šå—ï¼Ÿ')) {
            await fetch('/api/reset-stats', { method: 'POST' });
            location.href = '/settings?msg=reset_ok';
        }
    }

    window.onload = async function () {
        // V1.3.12 Diagnosis Check
        try {
            const res = await fetch('/api/admin/diagnose');
            if (res.ok) {
                const data = await res.json();
                if (data.status === 'error') {
                    document.getElementById('diagnosis-card').style.display = 'block';
                }
            }
        } catch (e) {
            console.error("Diagnosis failed:", e);
        }

        // Bind Fix Button
        const fixBtn = document.getElementById('btn-fix-db');
        if (fixBtn) {
            fixBtn.onclick = async function () {
                if (!confirm("ç¡®å®šè¦å¼ºåˆ¶ä¿®å¤æ•°æ®åº“ç»“æ„å—ï¼Ÿ")) return;

                const btn = this;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¿®å¤ä¸­...';
                const logDiv = document.getElementById('fix-logs');
                logDiv.style.display = 'block';
                logDiv.innerText = "æ­£åœ¨è¯·æ±‚ä¿®å¤...";

                try {
                    const res = await fetch('/api/admin/fix_db', { method: 'POST' });
                    const data = await res.json();

                    if (res.ok && data.status === 'success') {
                        logDiv.innerHTML = `<span style="color:var(--success)">âœ… ä¿®å¤æˆåŠŸ!</span>\n` + data.logs.join('\n');
                        btn.innerHTML = '<i class="fas fa-check"></i> å·²ä¿®å¤';
                        btn.className = 'btn btn-primary'; // Change color
                        setTimeout(() => location.reload(), 3000);
                    } else {
                        logDiv.innerHTML = `<span style="color:var(--danger)">âŒ ä¿®å¤å¤±è´¥: ${data.error_msg || 'Unknown'}</span>\n` + (data.logs ? data.logs.join('\n') : '');
                        btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> é‡è¯•';
                        btn.disabled = false;
                    }
                } catch (e) {
                    logDiv.innerHTML = `<span style="color:var(--danger)">ç½‘ç»œé”™è¯¯: ${e}</span>`;
                    btn.disabled = false;
                }
            };
        }

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('msg') === 'restore_ok') {
            showToast("âœ… å¤‡ä»½å·²åˆå¹¶å®Œæˆï¼", true);
        } else if (urlParams.get('msg') === 'reset_ok') {
            showToast("âœ¨ ç»Ÿè®¡å·²å½’é›¶", true);
        } else if (urlParams.get('msg') === 'nuclear_ok') {
            showToast("ğŸ”¥ ç³»ç»Ÿå·²å½»åº•æ¸…ç©ºï¼Œç„•ç„¶ä¸€æ–°", true);
        } else if (urlParams.get('msg') === 'pwd_ok') {
            showToast("âœ… å¯†ç ä¿®æ”¹æˆåŠŸï¼", true);
        } else if (urlParams.get('msg') === 'pwd_err') {
            showToast("âŒ å¯†ç ä¿®æ”¹å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—§å¯†ç ", false);
        }
    }

    function addSubject() {
        const name = prompt("è¯·è¾“å…¥æ–°ç§‘ç›®åç§°ï¼š");
        if (name && name.trim()) {
            const f = document.createElement('form');
            f.method = 'POST'; f.action = '/subject/add';
            const i = document.createElement('input');
            i.name = 'name'; i.value = name.trim();
            f.appendChild(i); document.body.appendChild(f);
            f.submit();
        }
    }
</script>
{% endblock %}